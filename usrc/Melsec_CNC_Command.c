#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include "type.h"
#include "Melsec_CNC.h"
#include "log.h"


u8 buf[100] = {}; 


static int meslec_send_message(unsigned char *buf, int length)
{
	int res = 0;
	char* datarev = NULL;
	res = send (sock, (char*)(buf), length, 0);
	if(res<0)
	{
		zlg_debug("Send Error : %d\r\n",res);
		return 2;
	}	
	print_collect_data(buf,1,length);
	res = recv (sock, (char*)rev, sizeof(rev), 0);
	if(res>0)
	{
		datarev = rev;
		rev[res] = 0;
	}
	else
	{
		datarev = 0;
	}
	if(datarev!=0)
	{
		print_collect_data(datarev,0,res);
		if(0==melsec_cnc_analyze_data(datarev))
		{
		}
		else
		{
			if(close(sock)==0)
				zlg_debug("socket close OK\r\n");
			else
				zlg_debug("socket close failed\r\n");
			zlg_debug("analyze error! index \r\n");
			return 1;
			}
	}
	else
	{
		zlg_debug("receive data error! index\r\n");
		return 2;
	}	
	return 0;
}

static int program2_getprogramnumber2(long lProgramType,long requestid)
{
	union{
		unsigned char b[4];
		long v;
	}ID;
	ID.v=requestid;	
	int res=0;
	unsigned char m_addr=0x01;
	if(lProgramType==EZNC_MAINPRG)  m_addr=0x65;
	else if(lProgramType==EZNC_SUBPRG)   m_addr=0xc9;

	unsigned char p_send[]=
	{
		0x47,0x49,0x4f,0x50,
		0x01,0x00,0x01,0x00,
		0x44,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
        ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID 
        0x01,0x00,0x96,0x00,
		0x04,0x00,0x00,0x00,
		0x01,0x00,0x00,0x00,
		0x0d,0x00,0x00,0x00,
        0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,
		0x00,0xbf,0xcc,0x77,
		0x00,0x00,0x00,0x00,
        0x2d,0x00,0x00,0x00,
        m_addr,0x00,0x00,0x00,                  //2d 00 00 00  
        0x01,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,
        0x10,0x00,0x00,0x00
	};
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int servo_name_read(long laxisno, long requestid)
{
	int res = 0;
    union{
        unsigned char b[4];
        long v;
	 }ID;
	union{
    	unsigned char b[4];
    	long v;
 	}AX;
	ID.v = requestid;
	AX.v = laxisno;
	   
   unsigned char p_send[]=
   {
	   0x47,0x49,0x4f,0x50,
	   0x01,0x00,0x01,0x00,
	   0x44,0x00,0x00,0x00,   //length
	   0x00,0x00,0x00,0x00,   //sequence length
	   ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID       //reference ID
	   0x01,0xff,0xff,0xff,   //response expect
	   0x04,0x00,0x00,0x00,   //object key length
	   0x01,0x00,0x00,0x00,   //object key
	   0x0d,0x00,0x00,0x00,
	   0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,  //request oprate
	   0x00,0x00,0x00,0x03,
	   0x00,0x00,0x00,0x00,
	   0x7f,0x00,0x00,0x00,       //
	   0x01,0x00,0x00,0x00,      //	  
	   0x00,0x00,0x00,0x00,
	   AX.b[0],AX.b[1],AX.b[2],AX.b[3],           //   X=1  Y=2  Z=4
	   0x00,0x00,0x00,0x00,
	   0x10,0x00,0x00,0x00
	};    //1 bit byte  10 cstring
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int pos_get_current_position(long laxisno, long requestid)
{
	int res=0;
	union{
      unsigned char b[4];
      long v;
	 }ID;
	union{
    	unsigned char b[4];
    	long v;
	}AX;
	ID.v = requestid;
	AX.v = laxisno;	  
    unsigned char p_send[]=
	{
	   0x47,0x49,0x4f,0x50,
	   0x01,0x00,0x01,0x00,
	   0x44,0x00,0x00,0x00,            //length
	   0x00,0x00,0x00,0x00,             //sequence length
	   ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID  
	   0x01,0x00,0xdc,0x08,              //response expect
	   0x04,0x00,0x00,0x00,              //object key length
	   0x01,0x00,0x00,0x00,               //object key
	   0x0d,0x00,0x00,0x00,
	   0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,       //request oprate
	   0x00,0x00,0xdc,0x08,
	   0x00,0x00,0x00,0x00,
	   0x25,0x00,0x00,0x00,                     //   
	   0x03,0x00,0x00,0x00,                     //   
	   0x01,0x00,0x00,0x00,                     //
	   AX.b[0],AX.b[1],AX.b[2],AX.b[3],           //
	   0x00,0x00,0x00,0x00,
	   0x10,0x00,0x00,0x00   //1 bit byte  10 cstring
	};    
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int pos_get_machine_position(long laxisno, long requestid)
{
	int i=0;
	int res = 0;
    union{
		unsigned char b[4];
		long v;
	}ID;
		union{
    	unsigned char b[4];
    long v;
	}AX;
	ID.v = requestid;
	AX.v = laxisno;

    unsigned char p_send[]={
	   0x47,0x49,0x4f,0x50,
	   0x01,0x00,0x01,0x00,
	   0x44,0x00,0x00,0x00,            //length
	   0x00,0x00,0x00,0x00,             //sequence length
	   ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID  
	   0x01,0xff,0xff,0xff,              //response expect
	   0x04,0x00,0x00,0x00,              //object key length
	   0x01,0x00,0x00,0x00,               //object key
	   0x0d,0x00,0x00,0x00,
	   0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,       //request oprate
	   0x00,0x00,0x00,0x03,
	   0x00,0x00,0x00,0x00,
	   0x25,0x00,0x00,0x00,                     // 
	   0x02,0x00,0x00,0x00,                     //
	   0x01,0x00,0x00,0x00,
	   AX.b[0],AX.b[1],AX.b[2],AX.b[3],           //an
	   0x00,0x00,0x00,0x00,
	   0x10,0x00,0x00,0x00
	};    //1 bit byte  10 cstring
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int pos_get_work_position(long laxisno, long requestid)
{
	int res = 0;
	union{
		unsigned char b[4];
		long v;
	}ID;
	union{
		unsigned char b[4];
		long v;
	}AX;
	ID.v=requestid;
	AX.v=laxisno;

    unsigned char p_send[]={
	   0x47,0x49,0x4f,0x50,
	   0x01,0x00,0x01,0x00,
	   0x44,0x00,0x00,0x00,            //length
	   0x00,0x00,0x00,0x00,             //sequence length
	   ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID  
	   0x01,0xff,0xff,0xff,              //response expect
	   0x04,0x00,0x00,0x00,              //object key length
	   0x01,0x00,0x00,0x00,               //object key
	   0x0d,0x00,0x00,0x00,
	   0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,       //request oprate
	   0x00,0x00,0x00,0x03,
	   0x00,0x00,0x00,0x00,
	   0x25,0x00,0x00,0x00,                     //
	   0x01,0x00,0x00,0x00,                     // 
	   0x01,0x00,0x00,0x00,
	   AX.b[0],AX.b[1],AX.b[2],AX.b[3],           //
	   0x00,0x00,0x00,0x00,
	   0x10,0x00,0x00,0x00
	};    //1 bit byte  10 cstring
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int pos_get_distance(long laxisno, long requestid)
{
	int res = 0;
	union{
		unsigned char b[4];
		long v;
	}ID;
	union{
		unsigned char b[4];
		long v;
	}AX;
	ID.v=requestid;
	AX.v=laxisno;

    unsigned char p_send[]={
	   0x47,0x49,0x4f,0x50,
	   0x01,0x00,0x01,0x00,
	   0x44,0x00,0x00,0x00,            //length
	   0x00,0x00,0x00,0x00,             //sequence length
	   ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID  
	   0x01,0xff,0xff,0xff,              //response expect
	   0x04,0x00,0x00,0x00,              //object key length
	   0x01,0x00,0x00,0x00,               //object key
	   0x0d,0x00,0x00,0x00,
	   0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,       //request oprate
	   0x00,0x00,0x00,0x03,
	   0x00,0x00,0x00,0x00,
	   0x25,0x00,0x00,0x00,                     
	   0x06,0x00,0x00,0x00,                     
	   0x01,0x00,0x00,0x00,
	   AX.b[0],AX.b[1],AX.b[2],AX.b[3],           
	   0x00,0x00,0x00,0x00,
	   0x10,0x00,0x00,0x00
	};    //1 bit byte  10 cstring
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int servo_get_servo_monitor(long laxisno, long lindex, long requestid)
{
	int res = 0;
	union{
        unsigned char b[4];
        long v;
	}ID;
	union{
        unsigned char b[4];
        long v;
	}AX;  
	union{
        unsigned char b[4];
        long v;
	}addr;
	ID.v=requestid;
	addr.v=lindex+1;
	AX.v=laxisno;
    unsigned char p_send[]={
		0x47,0x49,0x4f,0x50,
		0x01,0x00,0x01,0x00,
		0x44,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID    
		0x01,0x00,0x69,0x09,
		0x04,0x00,0x00,0x00,
		0x01,0x00,0x00,0x00,
		0x0d,0x00,0x00,0x00,
		0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,0x00,
		0x49,0x69,0x09,0x00,0x00,0x00,0x00,
		0x3b,0x00,0x00,0x00,                          //
		addr.b[0],addr.b[1],addr.b[2],addr.b[3],
		0x01,0x00,0x00,0x00,
		AX.b[0],AX.b[1],AX.b[2],AX.b[3],           //AxisNo  x-1 y-2  z-4  4-8
		0x00,0x00,0x00,0x00,
		0x02,0x00,0x00,0x00
	};
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int time_read(long requestid)
{
	int res = 0;
	union{
		unsigned char b[4];
		long v;
	}ID;
	ID.v=requestid;	
	unsigned char t_type=1;
	if(requestid==ID_POWER)     t_type=1;     //01  
	if(requestid==ID_AUTO)      t_type=2;       //
	if(requestid==ID_START)     t_type=3;      //
	if(requestid==ID_PROCESS)   t_type=8;   // 
	unsigned char p_send[]={
		0x47,0x49,0x4f,0x50,
		0x01,0x00,0x01,0x00,
		0x44,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID       //reference ID
		0x01,0x00,0x96,0x00,
        0x04,0x00,0x00,0x00,
		0x01,0x00,0x00,0x00,
		0x0d,0x00,0x00,0x00,  //
        0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,//STR
		0x00,  0xbf,0xcc,0x77,
		0x00,0x00,0x00,0x00,
        0x28,0x00,0x00,0x00,     //28 00 00 00 01
        t_type,0x00,0x00,0x00,            
        0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,
        0x03,0x00,0x00,0x00
	};
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int process_block_num(long requestid)
{
	int res = 0;
	union{
    	unsigned char b[4];
        long v;
	}ID;
	ID.v=requestid;	
   unsigned char p_send[]=
   {
	   	0x47,0x49,0x4f,0x50,
		0x01,0x00,0x01,0x00,
		0x44,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID  
		0x01,0x00,0x00,0x00,
		0x04,0x00,0x00,0x00,
		0x01,0x00,0x00,0x00,
		0x0d,0x00,0x00,0x00,
		0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,
		0x00,0xed,0x12,0x00,
		0x00,0x00,0x00,0x00,
		0x2d,0x00,0x00,0x00,     //2d 
		0x67,0x00,0x00,0x00,
		0x01,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		0x03,0x00,0x00,0x00
   };
   	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int command2_get_command2(int ltype, int m_lindex, long requestid)
{
	int res = 0;
    union{
    	unsigned char b[4];
    	long v;
	}ID;
	ID.v = requestid;
	unsigned char addr0=0x01;
	unsigned char addr1=0x01;
	if(ltype==EZNC_S)        {addr0=0x01;addr1=0x00;}
	if(ltype==EZNC_T)        {addr0=0x65;addr1=0x00;}
	if(ltype==EZNC_M)        {addr0=0xc9;addr1=0x00;}
	if(ltype==EZNC_B)        {addr0=0x2d;addr1=0x01;} //  2d 01 00 00          //	  
	unsigned char p_send[]=
	{
		0x47,0x49,0x4f,0x50,
		0x01,0x00,0x01,0x00,
		0x44,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID           
		0x01,0x00,0x96,0x00,
		0x04,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x0d,0x00,0x00,0x00,    //0d
		0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,
		0x00,0xbf,0xcc,0x77,
		0x00,0x00,0x00,0x00,
		0x2b,0x00,0x00,0x00,               //2b COMMAND2 
		addr0,addr1,0x00,0x00,
		0x01,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		0x03,0x00,0x00,0x00
	};
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int feed_speed(long requestid)
{
	int res = 0;
	union{
        unsigned char b[4];
        long v;
	}ID;
	ID.v = requestid;	
	unsigned char p_send[]=
	{
		0x47,0x49,0x4f,0x50,
		0x01,0x00,0x01,0x00,
		0x44,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID 
		0x01,0x00,0x96,0x00,
		0x04,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x0d,0x00,0x00,0x00,
        0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,
		0x00,0xbf,0xcc,0x77,
		0x00,0x00,0x00,0x00,
        0x2a,0x00,0x00,0x00,                 //2a 00 00 00  
		0x01,0x00,0x00,0x00,                 //01
        0x01,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		0x10,0x00,0x00,0x00
	};
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int feed_act(long requestid)
{
	int res = 0;
	union{
		unsigned char b[4];
		long v;
	}ID;
	ID.v=requestid;	
	unsigned char p_send[]=
	{
		0x47,0x49,0x4f,0x50,
		0x01,0x00,0x01,0x00,
		0x44,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID 
		0x01,0x00,0x96,0x00,
		0x04,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x0d,0x00,0x00,0x00,
        0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,0x00,
        0xbf,0xcc,0x77,0x00,0x00,0x00,0x00,
        0x21,0x00,0x00,0x00,                   //21 00 00 00  
		0x01,0x00,0x00,0x00,                   //01  
        0x01,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		0x10,0x00,0x00,0x00
	};
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int read_rdy_hld(long requestid)
{
	int res = 0;
	union{
		unsigned char b[4];
		long v;
	}ID;
	ID.v = requestid;
    unsigned char p_send[]=
	{
	   0x47,0x49,0x4f,0x50,
	   0x01,0x00,0x01,0x00,
	   0x44,0x00,0x00,0x00,   //length
	   0x00,0x00,0x00,0x00,   //sequence length
		ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID       //reference ID
	   0x01,0x00,0x00,0x00,   //response expect
	   0x04,0x00,0x00,0x00,   //object key length
	   0x01,0x00,0x00,0x00,   //object key
	   0x0d,0x00,0x00,0x00,
	   0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,  //request oprate
	   0x00,0x00,0x00,0x03,
	   0x00,0x00,0x00,0x00,
	   0x23,0x00,0x00,0x00,    //
	   0x0a,0x00,0x00,0x00,   //   
	   0x01,0x00,0x00,0x00,
	   0x00,0x00,0x00,0x00,  // X=1  Y=2  Z=4
	   0x00,0x00,0x00,0x00,
	   0x10,0x00,0x00,0x00
	};
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}


static int read_rdy_mode(long requestid)
{
	int res = 0;
	union{
        unsigned char b[4];
        long v;
	}ID;
	ID.v = requestid;
   unsigned char p_send[]=
   {
	   0x47,0x49,0x4f,0x50,
	   0x01,0x00,0x01,0x00,
	   0x44,0x00,0x00,0x00,       //length
	   0x00,0x00,0x00,0x00,       //sequence length
	   ID.b[0],ID.b[1],ID.b[2],ID.b[3],  //Request ID
	   0x01,0x00,0x00,0x00,   //response expect
	   0x04,0x00,0x00,0x00,   //object key length
	   0x01,0x00,0x00,0x00,   //object key
	   0x0d,0x00,0x00,0x00,
	   0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,  //request oprate
	   0x00,0x00,0x00,0x03,
	   0x00,0x00,0x00,0x00,
	   0x23,0x00,0x00,0x00,       //
	   0x0b,0x00,0x00,0x00,         //	   
	   0x01,0x00,0x00,0x00,
	   0x00,0x00,0x00,0x00,  //   X=1  Y=2  Z=4
	   0x00,0x00,0x00,0x00,
	   0x10,0x00,0x00,0x00
	}; 
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int feed_rate(void)
{
	int res = 0;
	union {
		unsigned char b[4];
		long v;
	}ID;
	ID.v = ID_INPUT_FEEDRATE;
	unsigned char p_send[] = 
	{
		0x47,0x49,0x4f,0x50,
		0x01,0x00,0x01,0x00,
		0x44,0x00,0x00,0x00,   //length
		0x00,0x00,0x00,0x00,   //sequence length
		ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID     
		0x01,0x00,0x04,0x00,   //response expect
		0x04,0x00,0x00,0x00,   //object key length
		0x01,0x00,0x00,0x00,   //object key
		0x0d,0x00,0x00,0x00,
		0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,  //request oprate
		0x00,0x02,0x61,0x06,
		0x00,0x00,0x00,0x00,
		0x37,0x00,0x00,0x00,     //    
		0x64,0x90,0x01,0x00,   //	   
		0x01,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,  //X=1  Y=2  Z=4
		0x00,0x00,0x00,0x00,
		0x01,0x00,0x00,0x00 
	};
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int read_x_input(int s_n, unsigned char XL, unsigned char XH,long RequestID)
{
	int res = 0;
	union{
        unsigned char b[4];
        long v;
	}ID;
	ID.v=RequestID;	 
    unsigned char p_send[]=
	{
	   0x47,0x49,0x4f,0x50,
	   0x01,0x00,0x01,0x00,
	   0x44,0x00,0x00,0x00,   //length
	   0x00,0x00,0x00,0x00,   //sequence length
	   ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID     
	   0x01,0xff,0xff,0xff,   //response expect
	   0x04,0x00,0x00,0x00,   //object key length
	   0x01,0x00,0x00,0x00,   //object key
	   0x0d,0x00,0x00,0x00,
	   0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,  //request oprate
	   0x00,0x00,0x00,0x03,
	   0x00,0x00,0x00,0x00,
	   0x36,0x00,0x00,0x00,     // 
	   XL+0x01,XH,0x00,0x00,   //	   
	   0x01,0x00,0x00,0x00,
	   0x00,0x00,0x00,0x00,  //
	   0x00,0x00,0x00,0x00,
	   0x01,0x00,0x00,0x00
	};
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static void para_addr_deal(long par_num,int a_x,unsigned char p_addr[],unsigned char cnd_col_type[])
{
	union{
		unsigned char b[4];
		long v;
	}pv;
	if(par_num==1001)            //SYS_ON
	{
		cnd_col_type[0]=0x7e;    //
	   	if(a_x==0)  	cnd_col_type[1]=1;  
	    if(a_x==1)  	cnd_col_type[1]=2;  
		if(a_x==2)  	cnd_col_type[1]=4;  				    
		cnd_col_type[2]=0x10;
		pv.v=0x01;
	}
	else  if(par_num==1002)            //axisno    
	{
		cnd_col_type[0]=0x7e;    //
	   	if(a_x==0)  	cnd_col_type[1]=1;  
	    if(a_x==1)  	cnd_col_type[1]=2;  
		if(a_x==2)  	cnd_col_type[1]=4;  				    
		cnd_col_type[2]=0x10;
		pv.v=0x03;
	}
	else  if(par_num==1003)            //iunit
	{
		cnd_col_type[0]=0x7e;    //
	   	if(a_x==0)  	cnd_col_type[1]=1;  
	    if(a_x==1)  	cnd_col_type[1]=2;  
		if(a_x==2)  	cnd_col_type[1]=4;  				    
		cnd_col_type[2]=0x10;
		pv.v=0x05;
	}         
	else  if(par_num==1004)            //ctr l_uint
	{
		cnd_col_type[0]=0x7e;    //
	   	if(a_x==0)  	cnd_col_type[1]=1;  
	    if(a_x==1)  	cnd_col_type[1]=2;  
		if(a_x==2)  	cnd_col_type[1]=4;  				    
		cnd_col_type[2]=0x10;
		pv.v=0x07;
	}

    else  if(par_num==1005)            //plcuint
	{
		cnd_col_type[0]=0x7e;    //
	   	if(a_x==0)  	cnd_col_type[1]=1;  
	    if(a_x==1)  	cnd_col_type[1]=2;  
		if(a_x==2)  	cnd_col_type[1]=4;  				    
		cnd_col_type[2]=0x10;
		pv.v=600;
	}
	else  if(par_num==1006)            //mcmpuint
	{
		cnd_col_type[0]=0x7e;    //
	   	if(a_x==0)  	cnd_col_type[1]=1;  
	    if(a_x==1)  	cnd_col_type[1]=2;  
		if(a_x==2)  	cnd_col_type[1]=4;  				    
		cnd_col_type[2]=0x10;
		pv.v=602;
	}

	//1026-1031 
	else	if((par_num>=1026)&&(par_num<=1031)) 
	{
		cnd_col_type[0]=0x7e;
	    cnd_col_type[1]=1;      //
	    cnd_col_type[2]=0x10;   //
	    pv.v=par_num-1015;
	}  
	else    if((par_num>=1501)&&(par_num<=1574)) 
	{
		cnd_col_type[0]=0x7e;
	    cnd_col_type[1]=1;      //
	    cnd_col_type[2]=0x10;   //
	    pv.v=par_num;
	} 
	else    if((par_num>=1590)&&(par_num<=1593))  
	{  
        cnd_col_type[0]=0x7e;
	    cnd_col_type[1]=1;      //
	    cnd_col_type[2]=0x10;   //
	    pv.v=par_num;
	} 
    else    if((par_num>=12001)&&(par_num<=12014))   
	{ 
	    cnd_col_type[0]=0x7e;
	    cnd_col_type[1]=1;      //
	    cnd_col_type[2]=0x10;   //
	    pv.v=par_num;
	} 
    if(par_num==2011||par_num==2012)
	{
      	cnd_col_type[0]=0x7f;    //
		if(a_x==0)  	cnd_col_type[1]=1;  
	    if(a_x==1)  	cnd_col_type[1]=2;  
		if(a_x==2)  	cnd_col_type[1]=4;  
		cnd_col_type[2]=0x10;
		pv.v=par_num;
	}
	if(par_num==4007)
	{
		cnd_col_type[0]=0x66;
		cnd_col_type[1]=0;
		cnd_col_type[2]=0x10;
		pv.v=170+a_x;            //a_x,0 ,1 ,2 ,3
	}

	if((par_num>=1037)&&(par_num<=1045))
	{
	   	cnd_col_type[0]=0x7e;    //
	    cnd_col_type[1]=0;
		cnd_col_type[2]=0x10;
		pv.v=par_num-1017;
	}

	if(par_num==1063)         //
	{
	    cnd_col_type[0]=0x7f;    //
	    cnd_col_type[1]=1;       //X-1  Y-2   Z-3
		cnd_col_type[2]=0x10;
		pv.v=par_num-960;
	}
	if((par_num>=1134)&&(par_num<=1155))
	{
	    cnd_col_type[0]=0x7e;    //
	    cnd_col_type[1]=0;
		cnd_col_type[2]=0x03;
		pv.v=par_num-1000;
	}

	if(par_num==8002)
	{
	   	cnd_col_type[0]=0x7e;    //
	    cnd_col_type[1]=0;
		cnd_col_type[2]=0x10;
		pv.v=par_num;
	}

    if((par_num>=8202)&&(par_num<=8217))  //
	{
        cnd_col_type[0]=0x7f;    //
	    cnd_col_type[1]=1;      //X=1  Y=2 Z=4
		cnd_col_type[2]=0x10;
		pv.v=par_num;
	}

    if(par_num==12800)
	{
		cnd_col_type[0]=0x81;    //81-PLCIndx_param
	   	cnd_col_type[1]=1;      //X=1  Y=2 Z=4
		cnd_col_type[2]=0x10;
	 	pv.v=par_num;
	}      
	p_addr[0]=pv.b[0];
	p_addr[1]=pv.b[1];
	p_addr[2]=pv.b[2];
	p_addr[3]=pv.b[3];
}

static int parameter3_get_parameter_data3(long lgroup,long litem,long lsize,long lsxis,long requestid)
{
	int res = 0;
	union{
		unsigned char b[4];
		long v;
	}ID;
	ID.v = requestid;	    
	unsigned char  par_addr[4];
	unsigned char  cmd_col_type[4];		 
	para_addr_deal(litem,lsxis,par_addr,cmd_col_type);
	
    unsigned char p_send[]={
	   0x47,0x49,0x4f,0x50,
	   0x01,0x00,0x01,0x00,
	   0x44,0x00,0x00,0x00,   //length
	   0x00,0x00,0x00,0x00, //sequence length
	   ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID
	   0x01,0xff,0xff,0xff,   //response expect
	   0x04,0x00,0x00,0x00,   //object key length
	   0x01,0x00,0x00,0x00,   //object key
	   0x0d,0x00,0x00,0x00,
	   0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61,  //request oprate
	   0x00,0x00,0x00,0x03,
	   0x00,0x00,0x00,0x00,
	   cmd_col_type[0],0x00,0x00,0x00,                    // 
	   par_addr[0],par_addr[1],par_addr[2],par_addr[3],         // 
	   0x01,0x00,0x00,0x00,
	   cmd_col_type[1],0x00,0x00,0x00,                     //
	   0x00,0x00,0x00,0x00,
	   cmd_col_type[2],0x00,0x00,0x00
	};            //1 bit byte  10 cstring
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int spendel_rate(void)
{
     read_x_input(0,0x10,0x02,ID_INPUT_SPENDLERATE);
}

static int spindle_monitor(long requestid)
{
	int res = 0;
	union{
		unsigned char b[4];
		long v;
	}ID;
	ID.v=requestid;	
	unsigned char addr=1;
	if(requestid==ID_SPENDLE_GAIN)       addr=0x01;     //01  
	if(requestid==ID_SPENDLE_TEMP)       addr=0xdd;     //1=dd   
	if(requestid==ID_SPENDLE_LOAD)       addr=4;       //
	if(requestid==ID_SPENDLE_I)          addr=0xc9;    //
	if(requestid==ID_SPENDLE_SPEED)      addr=3;    //
    unsigned char p_send[]=
	{
		0x47,0x49,0x4f,0x50,
		0x01,0x00,0x01,0x00,
	   	0x44,0x00,0x00,0x00,   //length
	   	0x00,0x00,0x00,0x00,   //sequence length
	   	ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID       //reference ID
	   	0x01,0xff,0xff,0xff,               //response expect
	   	0x04,0x00,0x00,0x00,   //object key length
	   	0x01,0x00,0x00,0x00,   //object key
	   	0x0d,0x00,0x00,0x00,   //operatio length=12
	   	0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x44,0x61,0x74,0x61, //request oprate
	   	0x00,0x00,0x00,0x00,
	   	0x00,0x00,0x00,0x00,
	   	0x3f,0x00,0x00,0x00,                    //
	   	addr,0x00,0x00,0x00,                    //
	   	0x00,0x00,0x00,0x00,
	   	0x01,0x00,0x00,0x00,                    //
	   	0x00,0x00,0x00,0x00,
	   	0x03,0x00,0x00,0x00
	};
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

static int system_get_alarm(long lmessage_number,long lalarm_type,long requestid)
{
	int res=0;	
	union{
		unsigned char b[4];
		long v;
	}ID;
	ID.v=requestid;	
    unsigned char m_type=0x00;
	m_type=(unsigned char)(lalarm_type);
	unsigned char p_send[]=
	{
		0x47,0x49,0x4f,0x50,
		0x01,0x00,0x01,0x00,
		0x48,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		ID.b[0],ID.b[1],ID.b[2],ID.b[3],   //Request ID  
		0x01,0x01,0x57,0x09,
		0x04,0x00,0x00,0x00,
		0x01,0x00,0x00,0x00,
		0x1d,0x00,0x00,0x00,    //1d
		0x6d,0x6f,0x63,0x68,0x61,0x47,0x65,0x74,0x43,0x75,0x72,0x72,0x65,0x6e,0x74,   //mochaGetCurrent
		0x41,0x6c,0x61,0x72,0x6d,0x4d,0x73,0x67,0x46,0x69,0x72,0x73,0x74,0x00,              //AlarmMsgFirst
		0xf2,0x12,0x00,0x00,0x00,0x00,0x00,
		0x01,0x00,0x00,0x00,
		0x0a,0x00,0x00,0x00,
		0x00,m_type,0x00,0x00
	};
	res = meslec_send_message(p_send, p_send[8]+12);
	return res;
}

int get_melsec_cmd_str(void)
{
	if(program2_getprogramnumber2(EZNC_MAINPRG,ID_FILE_NAME)!=0)return -1;//读当前加工的文件名
	if(servo_name_read(AXIS_X,ID_SERVO_NAME1)!=0) return -1;
	if(servo_name_read(AXIS_Y,ID_SERVO_NAME2)!=0) return -1;
	if(servo_name_read(AXIS_Z,ID_SERVO_NAME3)!=0) return -1;
	if(pos_get_current_position(AXIS_X,ID_POS_CURRENT_X)!=0) return -1;
	if(pos_get_current_position(AXIS_Y,ID_POS_CURRENT_Y)!=0) return -1;
	if(pos_get_current_position(AXIS_Z,ID_POS_CURRENT_Z)!=0) return -1;
	if(pos_get_machine_position(AXIS_X,ID_POS_MACHINE_X)!=0) return -1;
	if(pos_get_machine_position(AXIS_Y,ID_POS_MACHINE_Y)!=0) return -1;
	if(pos_get_machine_position(AXIS_Z,ID_POS_MACHINE_Z)!=0) return -1;
	if(pos_get_work_position(AXIS_X,ID_POS_WORK_X)!=0) return -1;
	if(pos_get_work_position(AXIS_Y,ID_POS_WORK_Y)!=0) return -1;
	if(pos_get_work_position(AXIS_Z,ID_POS_WORK_Z)!=0) return -1;
	if(pos_get_distance(AXIS_X,ID_POS_DIS_X)!=0) return -1;
	if(pos_get_distance(AXIS_Y,ID_POS_DIS_Y)!=0) return -1;
	if(pos_get_distance(AXIS_Z,ID_POS_DIS_Z)!=0) return -1;
	if(servo_get_servo_monitor(AXIS_X,7,ID_SERVO_LOADX)!=0) return -1;
	if(servo_get_servo_monitor(AXIS_Y,7,ID_SERVO_LOADY)!=0) return -1;
	if(servo_get_servo_monitor(AXIS_Z,7,ID_SERVO_LOADZ)!=0) return -1;
	if(time_read(ID_POWER)!=0)   return -1;
	if(time_read(ID_AUTO)!=0)    return -1;
	if(time_read(ID_PROCESS)!=0) return -1;
	if(process_block_num(ID_BLOCK_NUM)!=0) return -1;
	if(command2_get_command2(EZNC_T, 1,ID_TOOL_NUM)!=0) return -1;
	if(feed_speed(ID_FEED_SET)!=0)     return -1;
	if(feed_act(ID_FEED_ACT)!=0)       return -1;
	if(read_rdy_hld(ID_RDY_HLD)!=0)    return -1;
	if(read_rdy_mode(ID_PROC_MODE)!=0) return -1;
	if(feed_rate()!=0)    return -1; 
	if(spendel_rate()!=0) return -1;
	if(parameter3_get_parameter_data3(8,8002,1,0,ID8002N)!=0) return -1;
	if(spindle_monitor(ID_SPENDLE_TEMP)!=0)  return -1;
	if(spindle_monitor(ID_SPENDLE_LOAD)!=0)  return -1;
	if(spindle_monitor(ID_SPENDLE_SPEED)!=0) return -1;
	if(system_get_alarm(10,M_ALM_NC_ALARM,ID_ALARM_MESSAGE)!=0) return -1;
	return 0;
}

int Get_SendDataCNT(void)
{
	return _Data_Num;
}